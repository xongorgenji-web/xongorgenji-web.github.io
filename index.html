<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reselling & Buying Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f3f6}

/* HEADER */
header{
  background:linear-gradient(90deg,#131921,#1f2933);
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h2{margin:0;color:#ff9900}
header button{
  background:#ffd814;
  border:none;
  padding:8px 14px;
  font-weight:bold;
  cursor:pointer;
  border-radius:4px;
}

/* SEARCH */
.search-box{
  background:#fff;
  padding:12px;
  display:grid;
  gap:8px;
}
.search-box input{
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
}

/* CATEGORIES */
.categories{
  display:flex;
  gap:12px;
  padding:12px;
  background:#fff;
  overflow-x:auto;
}
.category{
  min-width:90px;
  padding:10px;
  background:#f8f8f8;
  border-radius:10px;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
}

/* PRODUCTS */
.products{
  padding:15px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:15px;
}
.product{
  background:#fff;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  overflow:hidden;
}
.product img{
  width:100%;
  height:170px;
  object-fit:cover;
}
.product-body{padding:12px}
.price{color:#b12704;font-weight:bold}

/* BUTTONS */
.whatsapp-btn{
  background:#25D366;
  color:#fff;
  border:none;
  padding:10px;
  width:100%;
  font-weight:bold;
  border-radius:5px;
  margin-top:8px;
  cursor:pointer;
}
.comment-box{
  margin-top:8px;
}
.comment-box textarea{
  width:100%;
  padding:8px;
  border-radius:5px;
  border:1px solid #ccc;
}
.comment-box button{
  width:100%;
  margin-top:6px;
  padding:8px;
  background:#ff9900;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
.comment{
  background:#f1f3f6;
  padding:6px;
  border-radius:4px;
  margin-top:4px;
  font-size:13px;
}
</style>
</head>

<body>

<header>
  <h2>ğŸ” Reselling & Buying Products</h2>
  <button onclick="logout()">Logout</button>
</header>

<!-- SEARCH (FIXED âœ…) -->
<div class="search-box">
  <input id="searchName"
         placeholder="ğŸ” Search product name"
         oninput="loadProducts()">

  <input id="searchLocation"
         placeholder="ğŸ“ Village or District"
         oninput="loadProducts()">
</div>

<!-- CATEGORIES -->
<div class="categories">
  <div class="category" onclick="setCategory('')">ğŸ  All</div>
  <div class="category" onclick="setCategory('Phones')">ğŸ“± Phones</div>
  <div class="category" onclick="setCategory('Clothes')">ğŸ‘• Clothes</div>
  <div class="category" onclick="setCategory('Electronics')">ğŸ’» Electronics</div>
  <div class="category" onclick="setCategory('Furniture')">ğŸª‘ Furniture</div>
  <div class="category" onclick="setCategory('Bike')">ğŸï¸ Bike</div>
  <div class="category" onclick="setCategory('Car')">ğŸš— Car</div>
</div>

<!-- PRODUCTS -->
<div class="products" id="productList"></div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCk8AopowtdPEZeYXsnEiT1o85kngAgG0Y",
  authDomain:"genji-store.firebaseapp.com",
  projectId:"genji-store"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentUserId=null;
let selectedCategory="";

auth.onAuthStateChanged(user=>{
  if(!user){location.replace("login.html");return;}
  currentUserId=user.uid;
  loadProducts();
});

function loadProducts(){
  const nameFilter=searchName.value.toLowerCase();
  const locFilter=searchLocation.value.toLowerCase();

  db.collection("products")
    .where("status","==","available")
    .onSnapshot(snapshot=>{
      productList.innerHTML="";
      snapshot.forEach(doc=>{
        const p=doc.data();
        if(selectedCategory && p.category!==selectedCategory) return;
        if(nameFilter && !p.name.toLowerCase().includes(nameFilter)) return;
        if(locFilter && !(`${p.village} ${p.district}`.toLowerCase().includes(locFilter))) return;

        const div=document.createElement("div");
        div.className="product";

        div.innerHTML=`
          <img src="${p.image}" onerror="this.src='https://via.placeholder.com/300'">
          <div class="product-body">
            <h4>${p.name}</h4>
            <div class="price">â‚¹${p.price}</div>
            <p>ğŸ“ ${p.village}, ${p.district}, ${p.state}</p>

            <button class="whatsapp-btn"
              onclick="openWhatsApp('${p.contact}','${p.name}')">
              ğŸ’¬ Chat on WhatsApp
            </button>

            <div class="comment-box">
              <textarea id="c_${doc.id}" placeholder="Ask a question..."></textarea>
              <button onclick="addComment('${doc.id}')">ğŸ’¬ Comment</button>
              <div id="comments_${doc.id}"></div>
            </div>
          </div>
        `;
        productList.appendChild(div);
        loadComments(doc.id);
      });
    });
}

function setCategory(cat){
  selectedCategory=cat;
  loadProducts();
}

function openWhatsApp(num,name){
  const msg=encodeURIComponent(`Hi, I am interested in your ${name}.`);
  window.open(`https://wa.me/91${num}?text=${msg}`,"_blank");
}

/* COMMENTS */
function addComment(productId){
  const text=document.getElementById("c_"+productId).value.trim();
  if(!text) return;

  db.collection("products").doc(productId)
    .collection("comments")
    .add({
      text:text,
      userId:currentUserId,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

  document.getElementById("c_"+productId).value="";
}

function loadComments(productId){
  db.collection("products").doc(productId)
    .collection("comments")
    .orderBy("createdAt","desc")
    .limit(3)
    .onSnapshot(snapshot=>{
      const box=document.getElementById("comments_"+productId);
      box.innerHTML="";
      snapshot.forEach(doc=>{
        box.innerHTML+=`<div class="comment">ğŸ’¬ ${doc.data().text}</div>`;
      });
    });
}

function logout(){
  auth.signOut().then(()=>location.replace("login.html"));
}
</script>

</body>
</html>